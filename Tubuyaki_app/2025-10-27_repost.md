# リポスト機能の実装

## ✅ 行ったこと

- リポスト機能の実装を行なった

## ①DB追加（Reposts テーブル & カウンタ）
```
rails g model Repost user:references post:references
```
意味
- これは「Repost というモデルと、その対応するテーブル（reposts）を作る」という命令
- 後ろの user:references post:references は「ユーザーと投稿（Post）に紐づく外部キーを作る」という指定

Rails が自動生成するもの
- app/models/repost.rb（モデルファイル）
- db/migrate/2025xxxxxx_create_reposts.rb（マイグレーションファイル）

マイグレーションの中身（生成例）
```
class CreateReposts < ActiveRecord::Migration[8.0]
  def change
    create_table :reposts do |t|
      t.references :user, null: false, foreign_key: true
      t.references :post, null: false, foreign_key: true
      t.timestamps
    end
  end
end
```
ここで t.references :user は、実際には user_id というカラムを作り、users テーブルへの外部キー制約を自動的に付与する<br>
同様に t.references :post は post_id を作り、posts テーブルと関連づける<br>
<br>

このテーブルの役割
- reposts テーブルは、「誰がどの投稿をリツイートしたか」を記録する中間テーブルで、ユーザーと投稿の多対多関係を管理するテーブル

| カラム名 | 型 | 説明 |
| ---- | ---- | ---- |
| id | integer | 主キー（自動採番） |
| user_id | integer | リポストしたユーザー |
| post_id | integer | リポストされた投稿 |
| created_at/updated_at | datetime | Railsが自動で管理 |

さらに、ここでマイグレーションファイルに以下の文を追加する
```
class CreateReposts < ActiveRecord::Migration[8.0]
  def change
    create_table :reposts do |t|
      t.references :user, null: false, foreign_key: true
      t.references :post, null: false, foreign_key: true
      t.timestamps
    end
    add_index :reposts, [:user_id, :post_id], unique: true
  end
end
```
追加文の意味
- add_index の基本
  Rails のマイグレーションで使う add_index は、データベースの検索を速くしたり、一意性を保証したりするために「インデックス」という仕組みを作るコマンド
  ```
  add_index :テーブル名, :カラム名
  ```
  で、そのカラムにインデックスを貼る。
  複数カラムの組み合わせにも対応していて、今回のように配列を渡すと：
  ```
  add_index :reposts, [:user_id, :post_id]
  ```
  → 「user_id と post_id のペアをセットで高速に検索できるようにする」インデックスが作られる。
- unique: true とは
  unique: true をつけると、同じ組み合わせの値が2回登録されないようにする（重複禁止） 制約を追加できる

  | user_id | post_id | 登録OKか |
  | ---- | ---- | ---- |
  | 1 | 10 | ✅ OK（初回リツイート） |
  | 1 | 10 | ❌ NG（同じユーザーが同じ投稿を再リツイート） |
  | 2 | 10 | ✅ OK（別のユーザーなのでOK） |
  | 1 | 11 | ✅ OK（別の投稿なのでOK） |

<br>

```
rails g migration AddRepostsCountToPosts reposts_count:integer
```
意味
- 「posts テーブルに reposts_count という整数カラムを追加する」という命令で、いいね数と同じように、投稿ごとのリツイート数を高速に集計するために追加

生成されるマイグレーション
```
class AddRepostsCountToPosts < ActiveRecord::Migration[7.1]
  def change
    add_column :posts, :reposts_count, :integer
  end
end
```
ここで、以下のように修正する
```
add_column :posts, :reposts_count, :integer, default: 0, null: false
```
初期値（default）と空許可（null）を指定する

<br>

```
rails db:migrate
```
マイグレーションする

## ②モデル
app/models/repost.rb
```
class Repost < ApplicationRecord
  belongs_to :user
  belongs_to :post, counter_cache: :reposts_count

  validates :user_id, uniqueness: { scope: :post_id }
end
```

app/models/post.rb
```
class Post < ApplicationRecord
  belongs_to :user
  has_many :likes,   dependent: :destroy
  has_many :reposts, dependent: :destroy

  def reposted_by?(user)
    return false unless user
    reposts.exists?(user_id: user.id)
  end
end
```

app/models/user.rb
```
class User < ApplicationRecord
  has_secure_password
  has_many :posts,   dependent: :destroy
  has_many :likes,   dependent: :destroy
  has_many :reposts, dependent: :destroy
end
```

ここのコードについては、2025-09-23_like_model.mdを参考にする

## ③ルーティング
config/routes.rb
```
resources :posts, only: [:index, :new, :create, :show, :destroy, :edit, :update] do
  resource :repost, only: [:create, :destroy]   # POST /posts/:post_id/repost, DELETE ...
end
```
repostの部分を追加<br>

## ④コントローラー
app/controllers/reposts_controller.rb
```
class RepostsController < ApplicationController
  include ActionView::RecordIdentifier
  before_action :authenticate_user!
  before_action :set_post

  def create
    current_user.reposts.find_or_create_by!(post: @post)
    @post.reload
    respond_to do |format|
      format.html { redirect_back fallback_location: post_path(@post) }
      format.turbo_stream do
        render turbo_stream: [
          turbo_stream.replace(
            dom_id(@post, :repost_button),
            partial: "posts/repost_button",
            locals: { post: @post }
          )
        ]
      end
    end
  end

  def destroy
    current_user.reposts.where(post: @post).destroy_all
    @post.reload
    respond_to do |format|
      format.html { redirect_back fallback_location: post_path(@post) }
      format.turbo_stream do
        render turbo_stream: [
          turbo_stream.replace(
            dom_id(@post, :repost_button),
            partial: "posts/repost_button",
            locals: { post: @post }
          )
        ]
      end
    end
  end

  private
  def set_post
    @post = Post.find(params[:post_id])
  end
end
```
LikesControllerを参考に、
- likes → reposts に変更
- 置き換えターゲットIDも dom_id(@post, :repost_button) に（likeと衝突しない独自ID）

## ⑤ボタンのパーシャルファイル
app/views/posts/_repost_button.html.erb
```
<div id="<%= dom_id(post, :repost_button) %>">
  <% if logged_in? %>
    <% if post.reposted_by?(current_user) %>
      <%= button_to post_repost_path(post), method: :delete,
            class: "btn p-0 border-0 bg-transparent text-success fs-4 d-inline-flex align-items-center",
            data: { turbo: true } do %>
        <i class="bi bi-arrow-repeat"></i>
        <span class="ms-1"><%= post.reposts_count %></span>
      <% end %>
    <% else %>
      <%= button_to post_repost_path(post), method: :post,
            class: "btn p-0 border-0 bg-transparent text-muted fs-4 d-inline-flex align-items-center",
            data: { turbo: true } do %>
        <i class="bi bi-arrow-repeat"></i>
        <span class="ms-1"><%= post.reposts_count %></span>
      <% end %>
    <% end %>
  <% else %>
    <%= link_to login_path,
          class: "btn p-0 border-0 bg-transparent text-muted fs-4 d-inline-flex align-items-center" do %>
      <i class="bi bi-arrow-repeat"></i>
      <span class="ms-1"><%= post.reposts_count %></span>
    <% end %>
  <% end %>
</div>
```
アイコンは Bootstrap Icons の bi bi-arrow-repeat を使用して、`_like_button.html.erb`を参考に作成

## ⑥一覧/詳細のフッター
```
<div class="mt-2 pt-2 border-top position-relative z-3
            d-flex justify-content-between align-items-center">
  <!-- 左：いいね＋リツイート を横並び -->
  <div class="d-inline-flex align-items-center gap-3">    #ボタンが横並びになるように編集
    <%= render "posts/like_button",   post: post %>
    <%= render "posts/repost_button", post: post %>       #ボタンのパーシャルを追加
  </div>
```
横並びになるように実装、詳細は post→@post にする