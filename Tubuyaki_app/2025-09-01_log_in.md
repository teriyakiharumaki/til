# ログイン機能

## ✅ 行ったこと

- ログイン機能の実装

## sessionsコントローラーの作成
コンテナ内で以下を実行
```
rails g controller Sessions new create destroy
```
このコマンドで以下が生成される
- SessionsController（new, create, destroyの3アクション付き）
- ビュー3つ（new/create/destroy用。実際に使うのは new.html.erb）
- ヘルパー
- テストファイル
- （環境によっては）スタイルシート

## コントローラーの編集
app/controllers/sessions_controller.rb
```
class SessionsController < ApplicationController
  def new; end

  def create
    user = User.find_by(email: params[:email])
    if user&.authenticate(params[:password])
      session[:user_id] = user.id
      redirect_to root_path, notice: "Logged in"
    else
      flash.now[:alert] = "Invalid email or password"
      render :new, status: :unprocessable_entity
    end
  end

  def destroy
    reset_session
    redirect_to root_path, notice: "Logged out"
  end
end
```

## routesの編集
config/routes.rb
```
resource  :session, only: [:new, :create, :destroy]
get  "login",  to: "sessions#new"
post "login",  to: "sessions#create"
delete "logout", to: "sessions#destroy"
```

## viewの編集
app/views/sessions/new.html.erb
```
<div class="container mt-5">
  <h1 class="mb-4">Log in</h1>

  <%= form_with url: login_path, local: true do |f| %>
    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <%= email_field_tag :email, nil, class: "form-control", id: "email" %>
    </div>

    <div class="mb-3">
      <label for="password" class="form-label">Password</label>
      <%= password_field_tag :password, nil, class: "form-control", id: "password" %>
    </div>

    <%= submit_tag "Log in", class: "btn btn-success" %>
  <% end %>
</div>
```

## 共有ヘルパーの実装
app/controllers/application_controller.rb
```
class ApplicationController < ActionController::Base
  helper_method :current_user, :logged_in?

  def current_user
    @current_user ||= User.find_by(id: session[:user_id]) if session[:user_id]
  end
  def logged_in?
    current_user.present?
  end
  def authenticate_user!
    redirect_to login_path, alert: "Please log in" unless logged_in?
  end
end
```
これは、「ログイン情報をどこからでも使えるようにする」ための共通処理<br>

### helper_method :current_user, :logged_in?
コントローラのメソッドをビューでも使えるようにする設定。<br>
これがあるおかげで、コントローラからはもちろんビュー (.html.erb) でも <% if logged_in? %> や <%= current_user.name %> が呼べる。<br>
👉 つまり「ログイン中ユーザー情報をナビバーやページ内で使えるようにしている」。

### def current_user
```
def current_user
  @current_user ||= User.find_by(id: session[:user_id]) if session[:user_id]
end
```
- session[:user_id] … ログイン成功時に入れたユーザーID。それを使って User.find_by でDBからユーザーを探す。
- @current_user ||= なので、1リクエスト内で2回目以降はDBアクセスしない（メモ化）。
  - 最初に呼んだとき → DBからUserを探す
  - 2回目以降 → インスタンス変数 @current_user をそのまま返す

👉 「今ログインしてるユーザーを取得する」ためのメソッド。

### def logged_in?
```
def logged_in?
  current_user.present?
end
```
current_user が存在するかどうかを真偽値で返す。<br>
これで「ログインしてるかどうか」を簡単に判定できる。

### def authenticate_user!
```
def authenticate_user!
  redirect_to login_path, alert: "Please log in" unless logged_in?
end
```
ログインしていないユーザーがアクセスしたとき、ログイン画面に強制的に飛ばす処理。<br>
コントローラで
```
before_action :authenticate_user!, only: [:new, :create]
```
このように使うと、未ログインユーザーがアクセスするとログインページへリダイレクトされる。

### 共通ヘルパーのまとめ
- current_user … ログイン中のユーザーを返す（なければ nil）
- logged_in? … ログインしてるかどうかを判定
- authenticate_user! … ログインしてなければ強制的にログイン画面へ
- helper_method … これらをビューでも呼べるようにする

## サインアップフォームのbootstrap版view
```
<div class="container mt-5">
  <h1 class="mb-4">Sign up</h1>

  <%= form_with model: @user, url: users_path, local: true do |f| %>
    <div class="mb-3">
      <%= f.label :name, class: "form-label" %>
      <%= f.text_field :name, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= f.label :email, class: "form-label" %>
      <%= f.email_field :email, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= f.label :password, class: "form-label" %>
      <%= f.password_field :password, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= f.label :password_confirmation, class: "form-label" %>
      <%= f.password_field :password_confirmation, class: "form-control" %>
    </div>

    <%= f.submit "Create account", class: "btn btn-primary" %>
  <% end %>
</div>
```