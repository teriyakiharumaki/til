# マイページの実装

## ✅ 行ったこと

- マイページの実装をした

## 1.ルーティングの追加
詳細ページようのルーティング（show）を作る
```
resources :users, only: [:new, :create, :show]  # :showを追加
```

## 2.ナビバーにマイページに遷移する項目を追加
```
<% if logged_in? %>
  <%= link_to "マイページ", user_path(current_user), class: "btn btn-outline-secondary me-2" %>  # 追加
  <%= button_to "ログアウト", logout_path, method: :delete, class: "btn btn-outline-danger" %>
<% else %>
  ...
<% end %>
```

## 3.コントローラーの修正
users_controller.rbに追記
```
class UsersController < ApplicationController
  before_action :set_user # 追加

  def show # 追加
    @posts = @user.posts.includes(:user).order(created_at: :desc)
  end

  private
  def set_user # 追加
    @user = User.find(params[:id])
  end
end
```

## 4.マイページのviewを作成
views/users/show.html.erbを作成
```
<div class="container mt-5">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h4 mb-1"><%= @user.name %></h1>
      <div class="text-muted">Joined: <%= l(@user.created_at.to_date) %></div>
    </div>
    <div class="d-inline-flex gap-2">
      <% if logged_in? && current_user.id == @user.id %>
        <%= link_to "プロフィール編集", "#", class: "btn btn-outline-secondary" %>
        <%= link_to "新規投稿", new_post_path, class: "btn btn-outline-primary" %>
      <% end %>
    </div>
  </div>
  <hr>
  <h2 class="h5 mb-3">投稿一覧</h2>
  <% if @posts.any? %>
    <% @posts.each do |post| %>
      <div id="<%= dom_id(post) %>" class="card mb-3 position-relative">
        <div class="card-body position-relative">
          <div class="small text-muted mb-1">
            <strong><%= post.user&.name || "Unknown" %></strong>
            ・ <%= l(post.created_at, format: :short) rescue post.created_at.to_s %>
          </div>

          <p class="card-text mb-2"><%= simple_format(h(post.body)) %></p>
          <div class="mt-2 pt-2 border-top position-relative z-3
            d-flex justify-content-between align-items-center">
            <div>
              <%= render "posts/like_button", post: post %>
            </div>
            <div class="d-inline-flex gap-2">
              <% if logged_in? && post.user_id == current_user.id %>
                <%= link_to "編集", edit_post_path(post), class: "btn btn-outline-success btn-sm" %>
                <%= button_to "削除", post_path(post), method: :delete,
                      data: { turbo_confirm: "この投稿を削除します。よろしいですか？" },
                      class: "btn btn-outline-danger btn-sm" %>
              <% end %>
            </div>
          </div>
          <%= link_to "", post_path(post), class: "stretched-link" %>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="text-muted">投稿はまだありません。</div>
  <% end %>
</div>
```
今後実装するかもしれないプロフィール編集と、つぶやきが投稿できる新規投稿ボタンも追記

## 特定のユーザーの投稿のみを取り出す仕組み
この仕組みが実装できてる部分は、users_controller.rb
```
@posts = @user.posts.includes(:user).order(created_at: :desc)
```
ここでやっていること

### ①@user.posts
User モデルと Post モデルの アソシエーションによって、このユーザーが投稿したPostだけを取ってくる
モデル側の定義
```
# app/models/user.rb
class User < ApplicationRecord
  has_many :posts, dependent: :destroy
end

# app/models/post.rb
class Post < ApplicationRecord
  belongs_to :user
end
```
この関係から、
@user.posts と書くと「そのユーザーが所有する投稿（user_id が一致するもの）」だけが自動で抽出される<br>
👉 つまり、@user.posts は内部的に次のようなSQLを実行している：
```
SELECT "posts".*
FROM "posts"
WHERE "posts"."user_id" = 〇〇; -- @user.id の値
```

### ②.includes(:user)
N+1クエリを防ぐために、関連する User 情報を一度に取得する<br>
これがないと、ビューで post.user.name を表示するたびに SQL が走ってしまうので効率が悪い

### ③.order(created_at: :desc)
新しい順に並べる部分
この順序で .each を回すことで、最新の投稿から表示できる
