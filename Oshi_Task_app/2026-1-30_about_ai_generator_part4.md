# AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã«ã¤ã„ã¦ã®ç¶šãâ‘£

## âœ… è¡Œã£ãŸã“ã¨

- AIã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆæ©Ÿèƒ½ã®ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã®è§£èª¬

## ä¿®æ­£ã—ãŸã‚³ãƒ¼ãƒ‰
ai_comment_generator.rb
```
require "json"

class AiCommentGenerator
  MODEL = "gpt-4.1".freeze

  KEYS = %w[
    task_created_comment
    task_updated_comment
    task_deleted_comment
    task_completed_comment
    sub_task_completed_comment
    task_incomplete_comment
  ].freeze

  def initialize(api_key = ENV["OPENAI_API_KEY"] || Rails.application.credentials.dig(:openai, :api_key))
    @ai_client = OpenAI::Client.new(access_token: api_key)
  end

  def generate_and_save_all(oshi_profile)
    ai_comment = oshi_profile.build_ai_comment

    attrs = generate_comments_hash(oshi_profile)
    ai_comment.assign_attributes(attrs)
    ai_comment.save!
  end

  private

  def generate_comments_hash(oshi_profile)
    profile_info = <<~TEXT
      åå‰: #{oshi_profile.name}
      æ€§æ ¼: #{oshi_profile.personality}
      å¹´é½¢: #{oshi_profile.generation}
      æ€§åˆ¥: #{oshi_profile.gender}
      ä¸€äººç§°: #{oshi_profile.pronoun}
    TEXT

    prompt = <<~PROMPT
      ã‚ãªãŸã¯æ¬¡ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã€Œæ¨ã—æœ¬äººã€ã¨ã—ã¦è©±ã—ã¾ã™ã€‚
      èª­è€…ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æœ¬äººã€ã§ã™ã€‚å¿…ãšãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‘ã‘ã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚
    
      å‡ºåŠ›ã¯ **å¿…ãšJSONã®ã¿**ï¼ˆå‰å¾Œã«æ–‡ç« ã‚’ä»˜ã‘ãªã„ï¼‰ã§è¿”ã—ã¦ãã ã•ã„ã€‚
      ã‚­ãƒ¼ã¯æ¬¡ã®6ã¤ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„:
      #{KEYS.join(", ")}
    
      å„å€¤ï¼ˆã‚»ãƒªãƒ•ï¼‰ã®ãƒ«ãƒ¼ãƒ«:
      - 50æ–‡å­—ä»¥å†…ã€1æ–‡ï¼ˆé•·ãã¦ã‚‚2æ–‡ã¾ã§ï¼‰
      - ä¸€äººç§°ã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä¸€äººç§°ã‚’å¿…ãšä½¿ã†
      - æ–‡æœ«ã¯è‡ªç„¶ãªå£èª¿ï¼ˆæ€§æ ¼ã«åˆã‚ã›ã‚‹ï¼‰
      - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‘ã‘ãŸå‘¼ã³ã‹ã‘ãƒ»å…±æ„Ÿãƒ»åŠ±ã¾ã—ã‚’å¿…ãšå«ã‚ã‚‹
      - çŠ¶æ³èª¬æ˜ã¯ç¦æ­¢ï¼ˆä¾‹:ã€Œã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¦ã€œã€ã¿ãŸã„ãªèª¬æ˜æ–‡NGï¼‰
      - ã€Œé ‘å¼µã‚‹ã€ã¨ã„ã†å˜èªã¯ã§ãã‚‹ã ã‘ä½¿ã‚ãšã€åˆ¥è¡¨ç¾ã«è¨€ã„æ›ãˆã‚‹
      - ã‚»ãƒªãƒ•å†…ã§ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã¨ã„ã†å˜èªã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„
      - å‘¼ã³ã‹ã‘ã¯ã€Œã‚ãªãŸã€ã€Œå›ã€ãªã©è‡ªç„¶ãªè¡¨ç¾ã«ã™ã‚‹
      - çµµæ–‡å­—ã¯ç¦æ­¢
    PROMPT

    response = @ai_client.chat(
      parameters: {
        model: MODEL,
        temperature: 0.5,
        messages: [
          { role: "system", content: prompt },
          { role: "user", content: profile_info }
        ]
      }
    )

    text = response.dig("choices", 0, "message", "content").to_s
    payload = JSON.parse(text)

    attrs = payload.slice(*KEYS)
    KEYS.each { |k| attrs[k] = "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" if attrs[k].blank? }

    attrs
  rescue JSON::ParserError
    KEYS.index_with { "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" }
  end
end
```

# å„éƒ¨åˆ†ã®è§£èª¬

## `def generate_comments_hash(oshi_profile)`
- æ¨ã—ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦AIã«å•ã„åˆã‚ã›ã—ã€
- JSONå½¢å¼ã§ã‚³ãƒ¡ãƒ³ãƒˆç¾¤ã‚’å—ã‘å–ã‚Šã€
- DBã«å…¥ã‚Œã‚‰ã‚Œã‚‹Hashã«æ•´å½¢ã—ã¦è¿”ã™

```
OshiProfile
   â†“
AIã«é€ã‚‹æ–‡ç« ã‚’ä½œã‚‹
   â†“
OpenAI API å‘¼ã³å‡ºã—
   â†“
JSONæ–‡å­—åˆ—ã‚’å—ã‘å–ã‚‹
   â†“
Rubyã®Hashã«å¤‰æ›
   â†“
å¿…è¦ãªã‚­ãƒ¼ã ã‘æ®‹ã™
   â†“
ã‚¨ãƒ©ãƒ¼å¯¾ç­–ã—ã¦è¿”ã™
```

***

### `â‘¤JSONæ–‡å­—åˆ—ã‚’Rubyã®Hashã«å¤‰æ›`
```
payload = JSON.parse(text)
```
text ã¯ â€œAIãŒè¿”ã—ãŸcontentâ€ ã®éƒ¨åˆ†ã§ã€ä»Šå›ã®è¨­è¨ˆã§ã¯ JSONæ–‡å­—åˆ—ã«ãªã£ã¦ã‚‹æƒ³å®š

ä¾‹ï¼š
```
text = "{\"task_created_comment\":\"ã„ã„ã‚¹ã‚¿ãƒ¼ãƒˆã ã­\"}"
```
JSON.parse ã¯ã€ã“ã‚Œã‚’ Ruby ã® Hash ã«å¤‰ãˆã‚‹ï¼š
```
payload
# => { "task_created_comment" => "ã„ã„ã‚¹ã‚¿ãƒ¼ãƒˆã ã­" }
```
âš ï¸ å¤±æ•—(text ãŒ JSON ã˜ã‚ƒãªã‹ã£ãŸã‚Šã€å£Šã‚Œã¦ã‚‹ã¨)ï¼š
```
JSON::ParserError
```
ãŒèµ·ãã‚‹ã€ã ã‹ã‚‰â‘§ã® rescue ãŒå¿…è¦

#### `â‘£ã®open-ai gemãŒä¸€åº¦ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚‹ã®ã«ãªã‚“ã§å†åº¦ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã®ã‹ï¼Ÿ`
äºˆæƒ³ï¼šAPIã‹ã‚‰å¸°ã£ã¦ããŸã‚‚ã®ã®ãƒ‘ãƒ¼ã‚¹ã¨ã€ç”Ÿæˆã•ã‚ŒãŸä¸­èº«ã®ãƒ‘ãƒ¼ã‚¹ï¼Ÿ

æ­£ç¢ºãªæ›¸ãæ–¹
- âœ… ã€ŒAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“ã®ãƒ‘ãƒ¼ã‚¹ã€ã¨
- âœ… ã€ŒAIãŒç”Ÿæˆã—ãŸä¸­èº«ï¼ˆJSONæ–‡å­—åˆ—ï¼‰ã®ãƒ‘ãƒ¼ã‚¹ã€

ã®2æ®µéšãŒã‚ã‚‹

#### ä»Šèµ·ãã¦ã„ã‚‹ã€Œ2æ®µéšãƒ‘ãƒ¼ã‚¹ã€

#### ğŸ¥‡ ç¬¬1æ®µéšï¼šOpenAI APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ‘ãƒ¼ã‚¹ï¼ˆè‡ªå‹•ï¼‰
```
OpenAI API
   â†“ JSONï¼ˆæ–‡å­—åˆ—ï¼‰
ruby-openai gem
   â†“ JSON.parseï¼ˆè‡ªå‹•ï¼‰
responseï¼ˆRubyã®Hashï¼‰
```
ã“ã“ã¾ã§ã¯ã€æ›¸ã‹ãªãã¦ã‚‚open-ai gemãŒè‡ªå‹•ã§è¡Œã†
```
response = @ai_client.chat(...)
```
ã“ã®æ™‚ç‚¹ã§ã€**APIãŒè¿”ã—ãŸJSONã¯ã€ruby-openai ãŒå‹æ‰‹ã« JSON.parse ã—ã¦ãã‚Œã¦ã€Rubyã®Hashã¨ã—ã¦ response ã«å…¥ã£ã¦ã„ã‚‹**

ã¤ã¾ã‚Šã€**ã€Œç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã‚’ã¾ã¨ã‚ãŸâ€œAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“â€ã®ãƒ‘ãƒ¼ã‚¹ã€ã¯ruby-openai ãŒã™ã§ã«ã‚„ã£ã¦ãã‚Œã¦ã„ã‚‹**

#### ğŸ¥ˆç¬¬2æ®µéšï¼šAIãŒç”Ÿæˆã—ãŸä¸­èº«ã®ãƒ‘ãƒ¼ã‚¹ï¼ˆè‡ªåˆ†ã§ã‚„ã£ã¦ã„ã‚‹ï¼‰
response ã®ä¸­èº«ã‚’ dig ã™ã‚‹ã¨ï¼š
```
text = response.dig("choices", 0, "message", "content")
```
ã“ã“ã§å–ã‚Œã‚‹ text ã¯ï¼š
```
"{ \"task_created_comment\": \"ã„ã„ã‚¹ã‚¿ãƒ¼ãƒˆã ã­\", ... }"
```
ğŸ‘‰ ã“ã‚Œã¯ ãŸã ã®æ–‡å­—åˆ—ï¼ˆJSONã£ã½ã„æ–‡ç« ï¼‰

AIã¯ã€ŒJSONå½¢å¼ã§æ›¸ã„ã¦ã­ã€ã¨ãŠé¡˜ã„ã•ã‚Œã¦ã€JSONã£ã½ã„æ–‡ç« ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹ã ã‘

ã ã‹ã‚‰ã“ã“ã§ï¼š
```
payload = JSON.parse(text)
```
ã‚’ã—ã¦ã€
```
JSONæ–‡å­—åˆ—ï¼ˆAIã®æ–‡ç« ï¼‰
   â†“ JSON.parse
Rubyã®Hashï¼ˆpayloadï¼‰
```
ã«å¤‰æ›ã—ã¦ã„ã‚‹

ã¤ã¾ã‚Šã€**ã€ŒAIãŒç”Ÿæˆã—ãŸâ€œä¸­èº«ã®JSONæ–‡å­—åˆ—â€ã®ãƒ‘ãƒ¼ã‚¹ã€ã¯ã€è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã§ã‚„ã£ã¦ã„ã‚‹**

**å…¨ä½“çš„ãªæµã‚Œ**
```
â‘  OpenAI APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆJSONæ–‡å­—åˆ—ï¼‰
        â†“ ruby-openai ãŒè‡ªå‹•ãƒ‘ãƒ¼ã‚¹
â‘¡ responseï¼ˆRubyã®Hashï¼‰
        â†“ digã§ä¸­èº«ã®æ–‡å­—åˆ—ã‚’å–ã‚Šå‡ºã™
â‘¢ "{ ... }"ï¼ˆAIãŒä½œã£ãŸJSONæ–‡å­—åˆ—ï¼‰
        â†“ JSON.parseï¼ˆã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ï¼‰
â‘£ payloadï¼ˆRubyã®Hashï¼‰
```

**APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“ã®ãƒ‘ãƒ¼ã‚¹ï¼ˆgemãŒæ‹…å½“ï¼‰ã¨ã€AIãŒç”Ÿæˆã—ãŸJSONæ–‡å­—åˆ—ã®ãƒ‘ãƒ¼ã‚¹ï¼ˆè‡ªåˆ†ãŒæ‹…å½“ï¼‰**

### ãªã‚“ã§ã“ã‚“ãªäºŒé‡æ§‹é€ ã«ãªã‚‹ã®ã‹
ç†ç”±ï¼š
- OpenAI APIã¯ã€ŒJSONã§é€šä¿¡ã™ã‚‹APIã€
- ã§ã‚‚AIã¯ã€Œæ–‡ç« ã‚’ç”Ÿæˆã™ã‚‹å­˜åœ¨ã€
- ãã®æ–‡ç« ã®ä¸­ã«ã€ãŸã¾ãŸã¾JSONã‚’æ›¸ã„ã¦ã‚‚ã‚‰ã£ã¦ã„ã‚‹ã ã‘

ã ã‹ã‚‰ï¼š
- APIã®JSON ã¨
- AIãŒæ–‡ç« ã¨ã—ã¦ç”Ÿæˆã—ãŸJSON

ã¯åˆ¥ç‰©ã«ãªã‚‹

***

### `â‘¥å¿…è¦ãªã‚­ãƒ¼ã ã‘æŠœãå‡ºã™`
```
attrs = payload.slice(*KEYS)
```
**payload ã®ä¸­ã‹ã‚‰ KEYSã«ã‚ã‚‹ã‚‚ã®ã ã‘å–ã‚Šå‡ºã™**

ä¾‹ï¼š
```
payload = {
  "task_created_comment" => "A",
  "task_updated_comment" => "B",
  "hacker_key" => "C"
}
```
slice(*KEYS) å¾Œï¼š
```
attrs = {
  "task_created_comment" => "A",
  "task_updated_comment" => "B"
}
# "hacker_key" ã¯è½ã¡ã‚‹
```
AIãŒä½™è¨ˆãªã‚­ãƒ¼ã‚’è¿”ã—ãŸã‚Šã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒãƒ–ãƒ¬ã¦ã‚‚ã€**DBã«å…¥ã‚Œã‚‹ã®ã¯æŒ‡å®šã—ãŸã‚«ãƒ©ãƒ ã ã‘ã«ã§ãã‚‹ï¼ˆå®‰å…¨ï¼†å®‰å®šï¼‰**

å‚è€ƒã«ãªã‚‹ã‚µã‚¤ãƒˆï¼šhttps://k-koh.hatenablog.com/entry/2022/07/23/094741<br>
https://docs.ruby-lang.org/ja/latest/method/Hash/i/slice.html

***

### `â‘¦ç©ºãƒ‡ãƒ¼ã‚¿ã®ä¿é™º`
```
KEYS.each { |k| attrs[k] = "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" if attrs[k].blank? }
```
KEYSã‚’å…¨éƒ¨ãƒã‚§ãƒƒã‚¯ã—ã¦ã€
- å€¤ãŒ nil
- å€¤ãŒ ""ï¼ˆç©ºæ–‡å­—ï¼‰
- å€¤ãŒ " "ï¼ˆç©ºç™½ã ã‘ï¼‰

ã¿ãŸã„ãªã€Œç©ºã€ã‚’æ¤œå‡ºã—ãŸã‚‰ã€å›ºå®šã®æ–‡è¨€ã«ç½®ãæ›ãˆã‚‹

ã“ã“ã§ä½¿ã£ã¦ã‚‹ blank? ã¯ Rails ã®ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€Rubyã® nil? ã‚„ empty? ã‚ˆã‚Šå¼·ã„

blank?ã«ã¤ã„ã¦ã®å‚è€ƒã‚µã‚¤ãƒˆï¼šhttps://zenn.dev/take_tech/articles/f6dbbae4b78b59#3.-blank%3F

### `ç–‘å•â“ï¼šâ‘¦ ç©ºãƒ‡ãƒ¼ã‚¿ã®ä¿é™ºã§ã€KEYSã®ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ï¼ˆè£œæ­£ï¼Ÿï¼‰ã‚’è¡Œã£ã¦ã‚‹ã‘ã©ã€ã“ã‚Œã£ã¦ä¸Šã®è¡Œã§ã¯attrã‚’payload.slice(*KEYS)ã—ã¦ã¦ã€ã“ã®æ®µéšã§KEYãŒå£Šã‚Œã¦ãŸã‚‰ã‚„ã°ã„ããªã„ï¼Ÿ(?)`
å›ç­”ï¼š**KEY ãŒæ¬ ã‘ã¦ã„ã¦ã‚‚ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯å£Šã‚Œãªã„è¨­è¨ˆã«ãªã£ã¦ã„ã‚‹**

â‘¦ã®å‡¦ç†ãŒã€â‘¥ã§æ¬ ã‘ãŸã‚­ãƒ¼ã‚‚ã¡ã‚ƒã‚“ã¨è£œæ­£ã—ã¦ãã‚Œã‚‹

#### `å•é¡Œã®æµã‚Œã‚’ã‚‚ã†ä¸€åº¦è¦‹ã‚‹`
```
attrs = payload.slice(*KEYS)
KEYS.each { |k| attrs[k] = "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" if attrs[k].blank? }
```
ç–‘å•â“ï¼šslice ã®æ™‚ç‚¹ã§ KEY ãŒç„¡ã‹ã£ãŸã‚‰ã€ã‚‚ã†æ‰‹é…ã‚Œã˜ã‚ƒãªã„ï¼Ÿ

**ã€Œsliceã§æ¶ˆãˆã¦ã‚‚ã€å¾Œã§å¾©æ´»ã§ãã‚‹ã€**

#### ã‚±ãƒ¼ã‚¹1ï¼špayload ã«ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆ
ä¾‹ãˆã° AI ãŒã“ã‚“ãªJSONã‚’è¿”ã—ãŸã¨ã™ã‚‹ï¼š

```
payload = {
  "task_created_comment" => "OK",
  # task_updated_comment ãŒç„¡ã„ï¼
}
```
â‘¥ slice ã®çµæœ
```
attrs = payload.slice(*KEYS)
```
slice ã¯ã€Œå­˜åœ¨ã™ã‚‹ã‚­ãƒ¼ã ã‘ã€ã‚’æ‹¾ã†ã®ã§ï¼š
```
attrs
# => { "task_created_comment" => "OK" }
```
æ¬ ã‘ã¦ã‚‹ã‚­ãƒ¼ã¯**å…¥ã‚‰ãªã„ï¼ˆæ¶ˆãˆã‚‹ï¼‰**

â‘¦ã®å‡¦ç†ã§ã©ã†ãªã‚‹ï¼Ÿ
```
KEYS.each do |k|
  attrs[k] = "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" if attrs[k].blank?
end
```
ã“ã“ã§ä¾‹ãˆã°ï¼š
```
attrs["task_updated_comment"]
# => nil   ï¼ˆã‚­ãƒ¼ãŒç„¡ã„ã®ã§ nilï¼‰
```
nil.blank? ã¯ trueãªã®ã§ï¼š
```
attrs["task_updated_comment"] = "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚
```
çµæœï¼šæœ€çµ‚çš„ãª attrs ã¯ã“ã†ãªã‚‹
```
{
  "task_created_comment" => "OK",
  "task_updated_comment" => "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
  ...
}
```

æ¶ˆãˆã¦ã„ãŸã‚­ãƒ¼ãŒã€ã“ã“ã§å¾©æ´»ã—ã¦è£œæ­£ã•ã‚Œã‚‹ğŸ‘‰ ã ã‹ã‚‰ **ã€Œsliceã§æ¶ˆãˆãŸã‚‰çµ‚ã‚ã‚Šã€** ã§ã¯ãªã„

#### ã‚±ãƒ¼ã‚¹2ï¼šã‚­ãƒ¼ã¯ã‚ã‚‹ã‘ã©å€¤ãŒç©ºã®å ´åˆ
```
payload = {
  "task_created_comment" => "",
  "task_updated_comment" => "OK"
}
```
slice å¾Œ
```
attrs
# => {
#   "task_created_comment" => "",
#   "task_updated_comment" => "OK"
# }
```
â‘¦ ã®å‡¦ç†
```
attrs["task_created_comment"].blank?
# => true
```
ãªã®ã§ï¼š
```
attrs["task_created_comment"] = "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
```
ã«ç½®ãæ›ã‚ã‚‹

ğŸ‘‰ ã“ã‚Œã‚‚ã¡ã‚ƒã‚“ã¨è£œæ­£ã•ã‚Œã‚‹

#### ã‚±ãƒ¼ã‚¹ï¼“ï¼špayload ãŒãã‚‚ãã‚‚å£Šã‚Œã¦ã‚‹å ´åˆ
ä¾‹ãˆã°ï¼š
- JSON.parse ãŒå¤±æ•—ã—ãŸ
- text ãŒ JSON ã˜ã‚ƒãªã‹ã£ãŸ

ã“ã®å ´åˆã¯ï¼š
```
rescue JSON::ParserError
```

ã«é£›ã¶ã€ãã—ã¦ï¼š
```
KEYS.index_with { "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" }
```

ãŒè¿”ã‚‹ã€‚ã¤ã¾ã‚Šï¼š<br>
**slice ã¾ã§åˆ°é”ã—ãªã„ã®ã§ã€åˆ¥ãƒ«ãƒ¼ãƒˆã§å®Œå…¨ãª attrs ãŒä¿è¨¼ã•ã‚Œã‚‹ã€‚**

index_withã®å‚è€ƒã‚µã‚¤ãƒˆï¼šhttps://qiita.com/suketa/items/bbadce2c5eb43834b3a3

### **çµè«–ï¼šâ‘¦ã¯ã€KEYS ã«æ›¸ã„ã¦ã‚ã‚‹ã€Œæœ¬æ¥ã‚ã‚‹ã¹ãã‚­ãƒ¼ã€ã‚’1ã¤ãšã¤ãƒã‚§ãƒƒã‚¯ã—ã¦ã€attrs ã«ãã®ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯å€¤ãŒç©ºãªã‚‰ã€ãã®ã‚­ãƒ¼ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚»ãƒƒãƒˆã—ã¦ã€attrs ã«è£œå®Œã™ã‚‹**

***

### `â‘§rescueï¼ˆJSONãŒå£Šã‚Œã¦ãŸå ´åˆï¼‰`
```
rescue JSON::ParserError
  KEYS.index_with { "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" }
```
**rescue ã¯ä½•ï¼Ÿ**

ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰å…¨ä½“ã®ä¸­ã§ JSON::ParserError ãŒèµ·ããŸã‚‰ã€ã“ã“ã«é£›ã¶ã€‚

ã¤ã¾ã‚Šä¸»ã«ï¼š
```
payload = JSON.parse(text)
```

ãŒå¤±æ•—ã—ãŸã¨ãã®ä¿é™ºã€‚

**KEYS.index_with ã¯ä½•ï¼Ÿ**

KEYSã®é…åˆ—ã‹ã‚‰ã€åŒã˜å€¤ã‚’æŒã¤Hashã‚’ä½œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã€‚

ä¾‹ï¼š
```
KEYS.index_with { "X" }
```

çµæœï¼š
```
{
  "task_created_comment" => "X",
  "task_updated_comment" => "X",
  ...
}
```

**ãªã‚“ã§ã“ã‚ŒãŒè‰¯ã„ï¼Ÿ**

ç”Ÿæˆã«å¤±æ•—ã—ã¦ã‚‚ã€å‘¼ã³å‡ºã—å´ã¯ã€Œå¿…ãšåŒã˜å½¢ã®attrsãŒè¿”ã£ã¦ãã‚‹ã€ã‹ã‚‰ã€

```
ai_comment.assign_attributes(attrs)
ai_comment.save!
```

ãŒ ä¾‹å¤–ã§è½ã¡ã«ãã„

### `rescueã®ä¸Šã«ãƒãƒ³ã¨ãŠã„ã¦ã‚ã‚‹attrã£ã¦ãªã‚“ã `
**def generate_comments_hash(oshi_profile) ã®è¿”ã‚Šå€¤ã¯ã€æ­£å¸¸ã«å‡¦ç†ãŒçµ‚ã‚ã£ãŸå ´åˆã¯ attrs ã«ãªã‚‹**

ã“ã®ãŸã‚ã«å¿…è¦ï¼ï¼ï¼ï¼

ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ï¼š
```
def add
  a = 1
  b = 2
  a + b
end

add
# => 3
```
return a + b ã¨æ›¸ã„ã¦ãªãã¦ã‚‚ã€æœ€å¾Œã® a + b ãŒè¿”ã£ã¦ãã‚‹

#### ãªãœ attrs ãŒè¿”ã‚‹ã®ã‹ï¼ˆãŠã•ã‚‰ã„ï¼‰

Rubyã«ã¯ãƒ«ãƒ¼ãƒ«ãŒã‚ã£ã¦ï¼š

**ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸­ã§ æœ€å¾Œã«è©•ä¾¡ã•ã‚ŒãŸå¼ã®å€¤ãŒã€è‡ªå‹•çš„ã«è¿”ã‚Šå€¤ã«ãªã‚‹**

è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ï¼š
```
attrs
rescue JSON::ParserError
  ...
end
```
ã“ã® attrs ãŒã€Œæœ€å¾Œã«è©•ä¾¡ã•ã‚Œã‚‹å¼ã€ã ã‹ã‚‰ã€
```
generate_comments_hash(oshi_profile)
# => attrsï¼ˆHashï¼‰
```
ã«ãªã‚‹

#### å®Ÿéš›ã®æµã‚Œã‚’ã¤ãªã’ã‚‹ã¨(`generate_and_save_all(oshi_profile)`å†…)
```
attrs = generate_comments_hash(oshi_profile)
```

ã“ã“ã§ï¼š
1. generate_comments_hash ãŒå®Ÿè¡Œã•ã‚Œã‚‹
2. ä¸­ã§ attrs ãŒä½œã‚‰ã‚Œã‚‹
3. ãƒ¡ã‚½ãƒƒãƒ‰ã®æœ€å¾Œã« attrs ãŒè©•ä¾¡ã•ã‚Œã‚‹
4. ãã®å€¤ï¼ˆHashï¼‰ãŒå‘¼ã³å‡ºã—å…ƒã«è¿”ã‚‹
5. è¿”ã£ã¦ããŸHashãŒã€å·¦è¾ºã® attrs ã«ä»£å…¥ã•ã‚Œã‚‹

#### `ã ã‹ã‚‰ generate_and_save_all ã§ã¯å®‰å¿ƒã—ã¦ä½¿ãˆã‚‹`
```
attrs = generate_comments_hash(oshi_profile)
ai_comment.assign_attributes(attrs)
```
ã“ã“ã¯ï¼š

**ã€Œå¿…ãš attrs ã«ã¯ Hash ãŒå…¥ã£ã¦ãã‚‹ã€**

å‰æã§å®‰å…¨ã«æ›¸ã‘ã¦ã„ã‚‹
