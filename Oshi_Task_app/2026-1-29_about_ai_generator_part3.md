# AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã«ã¤ã„ã¦ã®ç¶šãâ‘¢

## âœ… è¡Œã£ãŸã“ã¨

- AIã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆæ©Ÿèƒ½ã®ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã®è§£èª¬

## ä¿®æ­£ã—ãŸã‚³ãƒ¼ãƒ‰
ai_comment_generator.rb
```
require "json"

class AiCommentGenerator
  MODEL = "gpt-4.1".freeze

  KEYS = %w[
    task_created_comment
    task_updated_comment
    task_deleted_comment
    task_completed_comment
    sub_task_completed_comment
    task_incomplete_comment
  ].freeze

  def initialize(api_key = ENV["OPENAI_API_KEY"] || Rails.application.credentials.dig(:openai, :api_key))
    @ai_client = OpenAI::Client.new(access_token: api_key)
  end

  def generate_and_save_all(oshi_profile)
    ai_comment = oshi_profile.build_ai_comment

    attrs = generate_comments_hash(oshi_profile)
    ai_comment.assign_attributes(attrs)
    ai_comment.save!
  end

  private

  def generate_comments_hash(oshi_profile)
    profile_info = <<~TEXT
      åå‰: #{oshi_profile.name}
      æ€§æ ¼: #{oshi_profile.personality}
      å¹´é½¢: #{oshi_profile.generation}
      æ€§åˆ¥: #{oshi_profile.gender}
      ä¸€äººç§°: #{oshi_profile.pronoun}
    TEXT

    prompt = <<~PROMPT
      ã‚ãªãŸã¯æ¬¡ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã€Œæ¨ã—æœ¬äººã€ã¨ã—ã¦è©±ã—ã¾ã™ã€‚
      èª­è€…ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æœ¬äººã€ã§ã™ã€‚å¿…ãšãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‘ã‘ã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚
    
      å‡ºåŠ›ã¯ **å¿…ãšJSONã®ã¿**ï¼ˆå‰å¾Œã«æ–‡ç« ã‚’ä»˜ã‘ãªã„ï¼‰ã§è¿”ã—ã¦ãã ã•ã„ã€‚
      ã‚­ãƒ¼ã¯æ¬¡ã®6ã¤ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„:
      #{KEYS.join(", ")}
    
      å„å€¤ï¼ˆã‚»ãƒªãƒ•ï¼‰ã®ãƒ«ãƒ¼ãƒ«:
      - 50æ–‡å­—ä»¥å†…ã€1æ–‡ï¼ˆé•·ãã¦ã‚‚2æ–‡ã¾ã§ï¼‰
      - ä¸€äººç§°ã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä¸€äººç§°ã‚’å¿…ãšä½¿ã†
      - æ–‡æœ«ã¯è‡ªç„¶ãªå£èª¿ï¼ˆæ€§æ ¼ã«åˆã‚ã›ã‚‹ï¼‰
      - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‘ã‘ãŸå‘¼ã³ã‹ã‘ãƒ»å…±æ„Ÿãƒ»åŠ±ã¾ã—ã‚’å¿…ãšå«ã‚ã‚‹
      - çŠ¶æ³èª¬æ˜ã¯ç¦æ­¢ï¼ˆä¾‹:ã€Œã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¦ã€œã€ã¿ãŸã„ãªèª¬æ˜æ–‡NGï¼‰
      - ã€Œé ‘å¼µã‚‹ã€ã¨ã„ã†å˜èªã¯ã§ãã‚‹ã ã‘ä½¿ã‚ãšã€åˆ¥è¡¨ç¾ã«è¨€ã„æ›ãˆã‚‹
      - ã‚»ãƒªãƒ•å†…ã§ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã¨ã„ã†å˜èªã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„
      - å‘¼ã³ã‹ã‘ã¯ã€Œã‚ãªãŸã€ã€Œå›ã€ãªã©è‡ªç„¶ãªè¡¨ç¾ã«ã™ã‚‹
      - çµµæ–‡å­—ã¯ç¦æ­¢
    PROMPT

    response = @ai_client.chat(
      parameters: {
        model: MODEL,
        temperature: 0.5,
        messages: [
          { role: "system", content: prompt },
          { role: "user", content: profile_info }
        ]
      }
    )

    text = response.dig("choices", 0, "message", "content").to_s
    payload = JSON.parse(text)

    attrs = payload.slice(*KEYS)
    KEYS.each { |k| attrs[k] = "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" if attrs[k].blank? }

    attrs
  rescue JSON::ParserError
    KEYS.index_with { "AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" }
  end
end
```

# å„éƒ¨åˆ†ã®è§£èª¬

## `def generate_comments_hash(oshi_profile)`
- æ¨ã—ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦AIã«å•ã„åˆã‚ã›ã—ã€
- JSONå½¢å¼ã§ã‚³ãƒ¡ãƒ³ãƒˆç¾¤ã‚’å—ã‘å–ã‚Šã€
- DBã«å…¥ã‚Œã‚‰ã‚Œã‚‹Hashã«æ•´å½¢ã—ã¦è¿”ã™

```
OshiProfile
   â†“
AIã«é€ã‚‹æ–‡ç« ã‚’ä½œã‚‹
   â†“
OpenAI API å‘¼ã³å‡ºã—
   â†“
JSONæ–‡å­—åˆ—ã‚’å—ã‘å–ã‚‹
   â†“
Rubyã®Hashã«å¤‰æ›
   â†“
å¿…è¦ãªã‚­ãƒ¼ã ã‘æ®‹ã™
   â†“
ã‚¨ãƒ©ãƒ¼å¯¾ç­–ã—ã¦è¿”ã™
```

***

### â‘ profile_info ã‚’ä½œã‚‹éƒ¨åˆ†
```
profile_info = <<~TEXT
  åå‰: #{oshi_profile.name}
  æ€§æ ¼: #{oshi_profile.personality}
  å¹´é½¢: #{oshi_profile.generation}
  æ€§åˆ¥: #{oshi_profile.gender}
  ä¸€äººç§°: #{oshi_profile.pronoun}
TEXT
```
**æ¨ã—ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æƒ…å ±ã‚’ã€AIã«æ¸¡ã™ãŸã‚ã®æ–‡ç« ã«å¤‰æ›ã—ã¦ã„ã‚‹**

å®Ÿéš›ã®ä¸­èº«ï¼š
```
åå‰: ç”°ä¸­
æ€§æ ¼: çœŸé¢ç›®
å¹´é½¢: å¤§äºº
æ€§åˆ¥: ç”·æ€§
ä¸€äººç§°: ä¿º
```
**ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆ<<~TEXTï¼‰**
- è¤‡æ•°è¡Œã®æ–‡å­—åˆ—ã‚’æ¥½ã«æ›¸ã‘ã‚‹Rubyæ§‹æ–‡
- ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è‡ªå‹•ã§æƒãˆã¦ãã‚Œã‚‹

å‚è€ƒã‚µã‚¤ãƒˆï¼šhttps://dexall.co.jp/articles/?p=1544#i-1

**#{ }ï¼ˆå¼å±•é–‹ï¼‰**
```
#{oshi_profile.name}
```
Rubyã®å¤‰æ•°ã‚’æ–‡å­—åˆ—ã®ä¸­ã«åŸ‹ã‚è¾¼ã‚€æ§‹æ–‡

å‚è€ƒã‚µã‚¤ãƒˆï¼šhttps://techracho.bpsinc.jp/hachi8833/2021_09_30/71369

***

### â‘¡prompt ã‚’ä½œã‚‹éƒ¨åˆ†ï¼ˆå‘½ä»¤æ›¸ï¼‰
```
prompt = <<~PROMPT
  ã‚ãªãŸã¯æ¬¡ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã€Œæ¨ã—æœ¬äººã€ã¨ã—ã¦è©±ã—ã¾ã™ã€‚
  ...
PROMPT
```
AIã«å¯¾ã™ã‚‹æŒ‡ç¤ºã®éƒ¨åˆ†

***

### â‘¢`OpenAI API å‘¼ã³å‡ºã—éƒ¨åˆ†`
```
response = @ai_client.chat(
  parameters: {
    model: MODEL,
    temperature: 0.5,
    messages: [
      { role: "system", content: prompt },
      { role: "user", content: profile_info }
    ]
  }
)
```
- OpenAI API ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
- AIã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚‹

**model**ï¼šã©ã®AIãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ã‹

**temperature**ï¼šæ–‡ç« ã®ãƒ©ãƒ³ãƒ€ãƒ åº¦

**messages**ï¼šChatGPTå½¢å¼ã®ä¼šè©±ãƒ­ã‚°
| role | æ„å‘³ |
| ---- | ---- |
| system | ãƒ«ãƒ¼ãƒ«ãƒ»äººæ ¼ |
| user | å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ |

**role: "system"**
- AIã®äººæ ¼ãƒ»ãƒ«ãƒ¼ãƒ«ãƒ»åˆ¶ç´„ã‚’æ±ºã‚ã‚‹
- ã€Œã‚ãªãŸã¯æ¨ã—æœ¬äººã§ã™ã€
- ã€ŒJSONã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€
- ã€Œç¦æ­¢ãƒ«ãƒ¼ãƒ«ã€

ğŸ‘‰ AIã®è¡Œå‹•ãƒ«ãƒ¼ãƒ«ã‚’æ±ºã‚ã‚‹å¸ä»¤å¡”

ã“ã‚Œã¯ã€Œä½•ã‚’ç”Ÿæˆã™ã‚‹ã‹ã€ã§ã¯ãªãã€**ã©ã†ã„ã†ãƒ«ãƒ¼ãƒ«ã§ç”Ÿæˆã™ã‚‹ã‹**ã‚’æŒ‡å®šã—ã¦ã„ã‚‹

**role: "user"**
- å®Ÿéš›ã«å‡¦ç†ã—ã¦ã»ã—ã„ãƒ‡ãƒ¼ã‚¿
- æ¨ã—ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±

ğŸ‘‰ ææ–™ï¼ˆã‚¤ãƒ³ãƒ—ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ï¼‰

user ã¯ã€**ã€Œã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«å‡¦ç†ã—ã¦ãã ã•ã„ã€ã¨ã„ã†**ç´ æãƒ»ä¸­èº«

**ä¾‹ãˆè©±ã§systemã¨userã‚’ç†è§£**
| role | å½¹å‰² | ä¾‹ |
| ---- | ---- | ---- |
| system | ãƒ¬ã‚·ãƒ”ãƒ»ãƒ«ãƒ¼ãƒ« | ã€Œå¡©ã¯ä½¿ã‚ãªã„ã€ã€Œå’Œé¢¨ã§ã€ã€Œ2äººå‰ã€ |
| user | é£Ÿæ | ã€Œé¶è‚‰ãƒ»ç‰ã­ããƒ»åµã€ |
| AI | èª¿ç† | å®Ÿéš›ã«æ–™ç†ã‚’ä½œã‚‹ |

#### `@ai_client.chat`ã«ã¤ã„ã¦
- @ai_client

  initialize ã§ä»£å…¥ã•ã‚ŒãŸã€ŒOpenAI::Client ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€

- chatï¼ˆãƒ¡ã‚½ãƒƒãƒ‰åï¼‰

  @ai_client ãŒæŒã£ã¦ã„ã‚‹ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã®åå‰

ã¤ã¾ã‚Šã€**ã€ŒOpenAI::Client ã‚¯ãƒ©ã‚¹ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ chat ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶ã€**

## `@ai_clientã®ãªã‹ã«chatãŒå…¥ã£ã¦ã‚‹????ã‚ˆãã‚ã‹ã‚‰ã‚“`

**æ•´ç†ï¼šã‚¯ãƒ©ã‚¹ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ã®é–¢ä¿‚**
```
ã‚¯ãƒ©ã‚¹ï¼ˆè¨­è¨ˆå›³ï¼‰
   â†“ new
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå®Ÿä½“ï¼‰
   â†“ .method
ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå‹•ä½œï¼‰
```

**ä¾‹ã®ã‚³ãƒ¼ãƒ‰ğŸ¶**
```
class Dog
  def bark
    "ã‚ã‚“ï¼"
  end
end

dog = Dog.new
dog.bark

```
ã“ã®ã¨ãï¼š
| åå‰ | æ­£ä½“ |
| ---- | ---- |
| Dog | ã‚¯ãƒ©ã‚¹ï¼ˆçŠ¬ã®è¨­è¨ˆå›³ï¼‰ |
| dog | ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå®Ÿéš›ã®çŠ¬ï¼‰ |
| bark | ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå ãˆã‚‹å‹•ä½œï¼‰ |

ğŸ‘‰ dog ã®ä¸­ã«ã€Œbarkã‚¯ãƒ©ã‚¹ã€ãŒå…¥ã£ã¦ã‚‹ã‚ã‘ã˜ã‚ƒãªã„<br>
ğŸ‘‰ dog ã¯ã€Œbark ã¨ã„ã†å‹•ä½œãŒã§ãã‚‹ã€ã ã‘

### ä»Šå›ã®ã‚³ãƒ¼ãƒ‰
```
@ai_client = OpenAI::Client.new(...)
```
- OpenAI::Client â†’ ã‚¯ãƒ©ã‚¹ï¼ˆè¨­è¨ˆå›³ï¼‰
- @ai_client â†’ ãã®ã‚¯ãƒ©ã‚¹ã‹ã‚‰ä½œã‚‰ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

```
@ai_client.chat(...)
```
ã“ã‚Œã¯ã€**ã€Œ@ai_client ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã€chat ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã•ã›ã¦ã„ã‚‹ã€**

### chatã¯ãƒ¡ã‚½ãƒƒãƒ‰ï¼Ÿ
```
OpenAI::Clientï¼ˆã‚¯ãƒ©ã‚¹ / è¨­è¨ˆå›³ï¼‰
 â”œâ”€ initializeï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
 â”œâ”€ chatï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ï¼‰  â† ã“ã‚Œ
 â”œâ”€ embeddingsï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
 â””â”€ ...
        â†“ new
@ai_clientï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ / å®Ÿä½“ï¼‰
```

### chatã®ä¸­èº«ã®æ“¬ä¼¼çš„ãªã‚³ãƒ¼ãƒ‰
```
module OpenAI
  class Client
    def chat(parameters:)
      # 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®JSONã‚’ä½œã‚‹
      body = {
        model: parameters[:model],
        messages: parameters[:messages],
        temperature: parameters[:temperature]
      }

      # 2. HTTPã§OpenAI APIã«é€ä¿¡ã™ã‚‹
      http_response = post("/v1/chat/completions", body)

      # 3. JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’Rubyã®Hashã«å¤‰æ›ã—ã¦è¿”ã™
      JSON.parse(http_response.body)
    end
  end
end

```
ã“ã‚“ãªæ„Ÿã˜
```
@ai_client.chat(parameters: {...})
```
ã¯ã€def chatã‚’å‘¼ã‚“ã§ã‚‹ã ã‘

### `chatãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã€OPENAIã®APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã¨ã€JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿”ã£ã¦ãã‚‹ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ`
æ­£ç¢ºã«è¨€ã†ã¨ï¼š
- âœ… OpenAIã®APIã¯ HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦JSONæ–‡å­—åˆ—ã‚’è¿”ã™
- âœ… ruby-openai ã® chat ãƒ¡ã‚½ãƒƒãƒ‰ãŒãã‚Œã‚’å—ã‘å–ã‚Šã€Rubyã®Hashã«å¤‰æ›ã—ã¦è¿”ã—ã¦ãã‚Œã‚‹

ã€ŒJSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿”ã£ã¦ãã‚‹ã€ã¨ã„ã†ã‚ˆã‚Šã€<br>
**ã€ŒJSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆæ–‡å­—åˆ—ï¼‰ã€ãŒè¿”ã£ã¦ãã‚‹**ã‚¤ãƒ¡ãƒ¼ã‚¸

```
response = @ai_client.chat(parameters: {...})
```
ã“ã‚Œã¯ã€
```
â‘  Rubyï¼ˆã‚ãªãŸã®ã‚¢ãƒ—ãƒªï¼‰
    â†“ HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
â‘¡ OpenAI APIã‚µãƒ¼ãƒãƒ¼
    â†“ JSONå½¢å¼ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
â‘¢ ruby-openai gem
    â†“ JSONæ–‡å­—åˆ—ã‚’ Rubyã®Hash ã«å¤‰æ›
â‘£ response ã« Hash ã¨ã—ã¦å…¥ã‚‹
```

**OpenAI API ãŒè¿”ã—ã¦ãã‚‹ã€Œç”Ÿã®JSONã€ã®ä¾‹**

APIçš„ã«ã¯ã€ã“ã‚“ãªJSONæ–‡å­—åˆ—ãŒè¿”ã£ã¦ãã‚‹ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ï¼š
```
{
  "id": "chatcmpl-xxxxx",
  "model": "gpt-4.1",
  "choices": [
    {
      "message": {
        "role": "assistant",
        "content": "{ \"task_created_comment\": \"ã„ã„ã‚¹ã‚¿ãƒ¼ãƒˆã ã­\" }"
      }
    }
  ]
}
```
ã“ã‚Œã¯ ãŸã ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆJSONæ–‡å­—åˆ—ï¼‰

**ruby-openaiãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨**

gemã®ä¸­ã§ï¼š
```
JSON.parse(http_response.body)
```
ã¿ãŸã„ãªå‡¦ç†ãŒã•ã‚Œã€å—ã‘å–ã‚‹ã¨ãã«ã¯ã€
```
response #=> Rubyã®Hash
```
ã«ãªã£ã¦ã„ã‚‹

### `JSON.parseã£ã¦ãªã«`
**JSONå½¢å¼ã®ã€Œæ–‡å­—åˆ—ã€ã‚’ã€Rubyã§ä½¿ãˆã‚‹ã€ŒHashï¼ˆã‚„Arrayï¼‰ã€ã«å¤‰æ›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰**

### ã¾ãšã€JSONã¨ã¯
JSONã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’æ–‡å­—ã§è¡¨ç¾ã™ã‚‹ãƒ«ãƒ¼ãƒ«ï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰

ä¾‹ï¼ˆJSONæ–‡å­—åˆ—ï¼‰ï¼š
```
{
  "name": "ç”°ä¸­",
  "age": 20
}
```
ã“ã‚Œã¯ãŸã ã® æ–‡å­—åˆ—ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€Rubyã¯ã“ã®ã¾ã¾ã ã¨ï¼š
```
json_text = "{ \"name\": \"ç”°ä¸­\", \"age\": 20 }"
```
ã¨ã—ã‹æ‰±ãˆãªã„ã€ã“ã®ã¾ã¾ã§ã¯ï¼š
```
json_text["name"]   # âŒ ã§ããªã„
```

### ã“ã“ã§ JSON.parse ã®å‡ºç•ª
```
require "json"

json_text = "{ \"name\": \"ç”°ä¸­\", \"age\": 20 }"
data = JSON.parse(json_text)
```
ã™ã‚‹ã¨ã€
```
data
# => { "name" => "ç”°ä¸­", "age" => 20 }
```
ã¤ã¾ã‚Šã€**æ–‡å­—åˆ—ã ã£ãŸJSONãŒã€Rubyã®Hashã«å¤‰æ›ã•ã‚Œã‚‹**

ã“ã‚Œã§ã€
```
data["name"]
# => "ç”°ä¸­"
```
ã¿ãŸã„ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹

***

### â‘£`AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’å–ã‚Šå‡ºã™`
```
text = response.dig("choices", 0, "message", "content").to_s
```
**response ã¯ä½•ï¼Ÿ**<br>
@ai_client.chat(...) ã®æˆ»ã‚Šå€¤ã§ã€Rubyã®Hashï¼ˆruby-openaiãŒAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹JSONã‚’ãƒ‘ãƒ¼ã‚¹ã—ãŸã‚‚ã®ï¼‰<br>
ä¸­èº«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã ã„ãŸã„ã“ã†ï¼š
```
response = {
  "choices" => [
    {
      "message" => {
        "content" => "{ \"task_created_comment\": \"...\" }"
      }
    }
  ]
}
```
**dig ã£ã¦ä½•ã—ã¦ã‚‹ï¼Ÿ**<br>
dig ã¯ã€Œãƒã‚¹ãƒˆã—ãŸHash/Arrayã®å¥¥ã®å€¤ã‚’å®‰å…¨ã«å–ã‚Šã«ã„ãã€ãƒ¡ã‚½ãƒƒãƒ‰<br>
ã“ã‚Œã¨ã»ã¼åŒã˜ï¼š
```
response["choices"][0]["message"]["content"]
```
ã§ã‚‚ã€â†‘ã¯é€”ä¸­ãŒ nil ã ã¨è½ã¡ã‚‹

ä¾‹ï¼šã‚‚ã— response["choices"] ãŒ nil ã ã£ãŸã‚‰â€¦
```
nil[0]
# => NoMethodError ã§è½ã¡ã‚‹
```
dig ã ã¨é€”ä¸­ãŒ nil ãªã‚‰ ãã“ã§ nil ã‚’è¿”ã—ã¦çµ‚äº†ã—ã¦ãã‚Œã‚‹
```
response.dig("choices", 0, "message", "content")
# => nil ã«ãªã£ã¦ã‚‚è½ã¡ãªã„
```

digã«ã¤ã„ã¦ã®ã‚µã‚¤ãƒˆï¼šhttps://qiita.com/mmaumtjgj/items/3790d9f00780cbe66b62

**`.to_sã¯ãªã‚“ã®ãŸã‚ï¼Ÿ`**<br>
dig ãŒ nil ã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã‚‰ã€æœ€å¾Œã«
- nil.to_s â†’ ""ï¼ˆç©ºæ–‡å­—ï¼‰

ã«ã—ã¦ å¾Œç¶šå‡¦ç†ãŒã€Œnilã§è½ã¡ãªã„ã€ã‚ˆã†ã«ã—ã¦ã‚‹<br>
å‚è€ƒã‚µã‚¤ãƒˆï¼šhttps://pikawaka.com/ruby/to_s

### `response.dig("choices", 0, "message", "content")ã®0ã£ã¦ãªã‚“ã§å¿…è¦ï¼Ÿ`
0 ã¯ã€
- âœ… "choices" ãŒ é…åˆ—ï¼ˆArrayï¼‰ã ã‹ã‚‰
- âœ… ãã®é…åˆ—ã®ã€Œæœ€åˆã®è¦ç´ ï¼ˆ0ç•ªç›®ï¼‰ã€ã‚’å–ã‚Šå‡ºã™ãŸã‚ã«å¿…è¦

responseä¸­èº«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
```
response = {
  "choices" => [
    {
      "message" => {
        "content" => "ã“ã‚“ã«ã¡ã¯ï¼"
      }
    },
    {
      "message" => {
        "content" => "åˆ¥æ¡ˆã®æ–‡ç« "
      }
    }
  ]
}
```
ãƒã‚¤ãƒ³ãƒˆã¯ã€
```
"choices" => [ ... ]
```
ğŸ‘‰ "choices" ã®å€¤ã¯ é…åˆ—ï¼ˆArrayï¼‰<br>
ä¸­ã«è¤‡æ•°ã®å€™è£œï¼ˆchoiceï¼‰ãŒå…¥ã‚‹è¨­è¨ˆã«ãªã£ã¦ã„ã‚‹

### `ãªã‚“ã§ choices ã¯é…åˆ—ãªã®ï¼Ÿ`
**OpenAI API ã¯ã€ã€Œè¤‡æ•°ã®å€™è£œã‚’ä¸€åº¦ã«è¿”ã›ã‚‹è¨­è¨ˆã€ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‰**

ãŸã¨ãˆã°å°†æ¥ï¼š

- temperature ã‚’ä¸Šã’ã¦
- è¤‡æ•°æ¡ˆã‚’åŒæ™‚ã«ç”Ÿæˆã—ãŸã‚Š
- ãƒ™ã‚¹ãƒˆãªå€™è£œã‚’é¸ã‚“ã ã‚Š

ã§ãã‚‹ã‚ˆã†ã«ã€æœ€åˆã‹ã‚‰é…åˆ—æ§‹é€ 

ä»Šã®è¨­å®šã§ã¯ã€ã»ã¼å¸¸ã«1ä»¶ã—ã‹è¿”ã‚‰ãªã„ã‘ã©ã€ãã‚Œã§ã‚‚æ§‹é€ ã¯é…åˆ—ã®ã¾ã¾